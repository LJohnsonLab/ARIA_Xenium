---
title: "Microglia states identification"
subtitle: ""
date: today
execute: 
  echo: false
  warning: false
  message: false
format: html
---


```{r}
library(Seurat)
library(tidyverse)
library(patchwork)
library(kableExtra)
### for violin plot customization
library(gtable)
library(grid)
library(ggtext)

microglia <- qs2::qs_read("data/20251202-microglia_processed.qs2")


```


## Finding cluster markers with `FindAllMarkers`

```{r}
# Set cluster identities
Idents(microglia) <- "seurat_clusters"
# Find markers with log2FC threshold of 0.25 and minimum percentage expression of 20%
microglia_markers <- FindAllMarkers(microglia, only.pos = F, min.pct = 0.5, logfc.threshold = 1)



```

__5 top markers per cluster in terms of log2FC as all adjusted p-values are 0.__

```{r}
genes_of_interest <- microglia_markers |> 
    group_by(cluster) |>
    arrange(desc(abs(avg_log2FC)),.by_group = T) |> 
    slice_head(n = 5) |> 
    pull(gene) |> 
    unique()
```

 Selected `r length(genes_of_interest)` unique genes of interest and fetched their normalized expression data for visualization.
 

```{r}
#| column: screen
#| fig-width: 15
#| fig-height: 8



# Fetch count data for the genes of interest
violin_data <- FetchData(microglia, c(genes_of_interest,"seurat_clusters"), layer = "scale.data")


violin_data_long <- violin_data  |> 
    pivot_longer(-seurat_clusters) |> 
    mutate(seurat_clusters = fct_rev(seurat_clusters),
           name = factor(name, levels = genes_of_interest))

cluster_levels <- levels(violin_data_long$seurat_clusters)
palette_colors <- scales::hue_pal()(length(cluster_levels))
names(palette_colors) <- cluster_levels

axis_labels <- setNames(cluster_levels, cluster_levels)

p <- ggplot(violin_data_long, aes(x = seurat_clusters, y = value, fill = seurat_clusters)) +
    geom_violin(aes(color = seurat_clusters),
                scale = "width", trim = TRUE, adjust = 1, show.legend = FALSE) +
    coord_flip() +
    scale_fill_manual(values = palette_colors) +
    scale_color_manual(values = palette_colors) +
    facet_wrap(~name, scales = "free_x", nrow = 1) +
    theme_minimal() +
    labs(x = "Cluster", y = "Expression Levels") +
    theme(
        legend.position = "left",
        axis.text.y = element_text(size = 12, color = palette_colors[cluster_levels]),
        axis.text.x = element_blank(),
        axis.title = element_text(size = 14, color = "grey30"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        strip.text = element_text(size = 10, face = "italic", angle = 90)
    ) +
    scale_x_discrete(labels = axis_labels)

g <- ggplotGrob(p)
axis_grobs <- which(grepl("axis-l", g$layout$name))

invisible(
  map(axis_grobs, function(i) {
    if (g$layout[i, "name"] != "axis-l-1-1") {
      g$grobs[[i]] <<- nullGrob()
    }
  })
)

grid.newpage()
grid.draw(g)
```

## Marker genes for Microglia states

Marker genes for various microglia states based on the previous single cell experiments with ARIA samples. Filtered to include only those present in the current panel.

```{r}
marker_genes <- list(
  proliferating = intersect(c("Hmgb2","H2az1","Stmn1","Birc5","Mki67"), Features(microglia)),
  dam_late = intersect(c("Cst7","Igf1","Fabp5","Gpnmb","Spp1"), Features(microglia)),
  antigen_presenting = intersect(c("H2-Ab1","H2-Eb1","H2-Aa","Cd74","Cp"), Features(microglia)),
  interferon_response = intersect(c("Ifit3","Ifit2","Oasl1","Ifit3b","Ifi211"), Features(microglia)),
  homeostatic = intersect(c("Ccr5","P2ry12","Gm10790","Zfhx3","Dock4","Chd9","Otulinl","Camk2n1","Tmem119","Marcks","Lpcat2"), Features(microglia)),
  nfkb_activated = intersect(c("Nfkbia","Il1b","Igf1","Nfkbiz","Bcl2a1b","Bclda1d"), Features(microglia)),
  dam_early = intersect(c("Serpine2","Cst7"), Features(microglia)),
  remodeling = intersect(c("Pixdc2","Gm37168","Ptchd1","Cacna1a","Klf6"), Features(microglia))
)
# Store signature names for later use in renaming columns
marker_names <- names(marker_genes)


# Calculate module scores for each signature 
# This computes the average expression of signature genes minus average expression of control genes


# Calculate module scores for each cell type marker
# Include the resulting scores in the metadata of the Seurat object
microglia <- AddModuleScore(
  object = microglia,
  features = marker_genes,
  name = "Marker",
  ctrl = 20,
  seed = 42)
```

```{r}
kbl(tibble(
  Marker = marker_names,
  Genes = map (marker_genes,\(x) paste(x, collapse = ", "))),
  caption = "Marker genes used for module score calculation") |>
  kable_styling(full_width = F, "striped")
```

Module scores were calculated using the `AddModuleScore` function in Seurat, which computes for each cell the average expression of signature genes minus the average expression of 20 randomly selected control genes, thereby controlling for technical variation and background expression levels.

```{r}
#| column: page
#| fig-width: 12
#| fig-height: 12

# Rename module score columns
n_new  <- length(marker_genes)
idx    <- (ncol(microglia@meta.data) - n_new + 1):ncol(microglia@meta.data)  # Index of new columns
colnames(microglia@meta.data)[idx] <- paste0(marker_names, " Score") 

# Visualize module scores on UMAP

markers <- FeaturePlot(microglia, features = names(microglia@meta.data)[idx],
            cols = c("#fdf9f9ff", "#cc0000"),
            # 
            min.cutoff ="q20",max.cutoff = "q90",
            combine = FALSE) |> 
map(\(x) x + NoAxes() + NoLegend() + 
            theme(plot.title = element_text(size = 12, vjust = 0),
                  panel.border = element_blank()))

# Arrange plots in a grid
wrap_plots(markers, ncol = 3)
```